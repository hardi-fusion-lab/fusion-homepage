---
title: "混合架构：HTTP、WebSocket 与 TCP"
summary: "结合多种协议的优势，设计一个鲁棒的交易系统通信层。"
date: "2024年9月10日"
readTime: "9 分钟阅读"
tags: ["网络", "系统设计", "WebSocket"]
image: "https://placehold.co/1200x600/0f172a/a78bfa?text=Hybrid+Architecture"
author:
  name: "Hardi Hsu"
  avatar: "https://github.com/hardihsu.png"
  role: "Lead Engineer"
claps: 189
---

交易系统不仅仅是一条管道，它是一个复杂的网络拓扑。我们采用了混合协议架构来平衡可靠性、速度和标准遵从性。

### 核心三要素

1.  **HTTP (REST)**: 管理层。
    *   *用途*: 用户登录、历史报表、设置、静态数据。
    *   *原因*: 在这里，可靠性和缓存比原始速度更重要。它是无状态且对缓存友好的。

2.  **WebSocket**: 实时脉搏。
    *   *用途*: 实时市场行情、订单状态更新。
    *   *原因*: 持久连接消除了 HTTP 握手开销。这通过对于“推送”类通知至关重要。

3.  **TCP / IPC**: 这网关骨干。
    *   *用途*: 撮合引擎与网关之间的内部通信。
    *   *原因*: 最大吞吐量，最小开销。

### 跨协议的状态管理

混合系统最大的挑战之一是保持“快照” (HTTP) 与“流” (WebSocket) 的一致性。

**序列号 (Sequence ID) 策略**:
系统中的每个事件（例如，订单成交）都分配有一个严格递增的序列 ID（101, 102, 103...）。

1.  用户加载页面 (HTTP): 获取订单历史。最新 SeqID = **100**。
2.  WebSocket 连接: 订阅更新。
3.  WebSocket 接收更新: "订单成交。SeqID = **102**"。
4.  **缺口检测**: 前端注意到错过了 SeqID **101**。它（或 Socket 库）立即请求“填补缺口”获取 101。

这确保了即使用户在从 REST 切换到 Socket 时网络波动，他们账户的试图在数学上也是保持一致的。

### “心跳”策略

移动网络是不可靠的。我们实现了每 3 秒一次的应用层心跳 (Ping/Pong)。

*   如果前端丢失了 2 个 Pong，它将进入“重连”模式。
*   发出的订单会在本地 Redux/Zustand 中排队。
*   重连后，队列会被刷新（带有时效性检查），以确保在短暂的隧道中断期间不会丢失用户意图。
