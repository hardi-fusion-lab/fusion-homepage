---
import StudioLayout from '@/layouts/StudioLayout.astro';
import { getCollection } from 'astro:content';
import type { InsightData, MediaItem } from '@/types';

// Components
import Navigation from '@/components/fusion-astro/Navigation.astro';
import HeroSection from '@/components/fusion-astro/HeroSection.astro';
import AboutSection from '@/components/fusion-astro/AboutSection.astro';
import InsightsSection from '@/components/fusion-astro/InsightsSection.astro';
import Footer from '@/components/fusion-astro/Footer.astro';
import SkillBadge from '@/components/fusion-astro/SkillBadge.astro';
import ProjectCard from '@/components/fusion-astro/ProjectCard.astro';
import ProjectModal from '@/components/fusion-astro/ProjectModal.astro';
import { Code2, Terminal, Cloud } from 'lucide-react';

// 1. Fetch Insights Collection
const allInsights = await getCollection('insights');

// 2. Transform to InsightData format
const sortedInsights = allInsights.sort((a, b) => {
    return new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf(); 
}).slice(0, 3); // Top 3

const insights = sortedInsights.map(post => ({
    id: post.slug,
    title: post.data.title,
    summary: post.data.summary,
    date: new Date(post.data.date).getFullYear().toString(),
    readTime: '5 min', // can estimate reading time if needed
    category: post.data.category,
    image: post.data.image || '',
    author: { name: post.data.author, avatar: '', role: '' },
    claps: 0,
    tags: post.data.tags,
    content: '' 
}));

// Skills Data
const skills = {
    frontend: ["React", "Next.js", "TypeScript", "Tailwind", "Framer Motion", "Astro"],
    backend: ["NestJS", "Node.js", "Python", "PostgreSQL", "Redis", "Prisma"],
    cloud: ["AWS", "Cloudflare", "Docker", "CI/CD", "System Design"]
};

// Projects Data
const projects = [
    {
        id: "project-futures",
        title: "Futures Trading Simulation Platform",
        description: "A comprehensive futures trading simulation environment built to mimic real-world exchange behavior. It provides a risk-free environment for traders to test strategies, featuring real-time market data, sub-millisecond order matching, and strict risk management controls.\n\nThe platform combines a C-Client for trader interaction, an Admin Dashboard for system management, and a robust backend engine handling market data ingestion and trade execution.",
        shortDescription: "A high-performance, real-time futures trading simulator designed for professional trader training.",
        tags: ["React", "NestJS", "WebSocket", "PostgreSQL", "High Performance"],
        media: [
             { type: 'image' as const, url: '/kline-chart.png', caption: 'Real-time K-Line Charting with TradingView' },
             { type: 'image' as const, url: '/futures-platform-dashboard.png', caption: 'Positions & Orders Management' }
        ] as MediaItem[],
        features: [
            "Real-time K-Line charting with TradingView Lightweight Charts integration.",
            "Tick-to-Bar data aggregation engine for historical data analysis.",
            "Sub-millisecond order matching simulation engine.",
            "Real-time P&L calculation and comprehensive position management.",
            "Admin Dashboard for instrument management, user controls, and fee templates.",
            "CTP Gateway integration for live market data ingestion from futures exchanges.",
            "Strict risk management implementation including margin calculation and liquidation logic."
        ],
        techStack: [
             { category: "Frontend", skills: ["React", "TypeScript", "Tailwind CSS", "Zustand", "TradingView Lib"] },
             { category: "Backend", skills: ["NestJS", "Node.js", "Python (CTP Gateway)", "Redis Pub/Sub", "Socket.io", "RxJS"] },
             { category: "Data & Infra", skills: ["PostgreSQL", "Redis", "Docker", "TimescaleDB"] }
        ],
        architecture: "Microservices-inspired modular architecture. Market Data Gateway streams ticks via Redis Pub/Sub to the Matching Engine and Data Service. The Frontend connects via WebSocket for real-time updates of Order Book, Quotes, and Account State. The entire system is type-safe end-to-end using shared TypeScript DTOs.",
        github: "#", 
        link: "#",
        featured: true,
        modal: true
    },
    {
        id: "project-algo",
        title: "Quantitative Order Execution System",
        description: "Algorithmic trading execution engine capable of handling complex order strategies. (Currently in development)",
        tags: ["Python", "Rust", "AWS", "Low Latency"],
        link: "",
        featured: false,
        modal: false,
        media: [] as MediaItem[],
        features: [],
        techStack: [],
        architecture: ""
    },
    {
        id: "project-portfolio",
        title: "Hardi Fusion Lab Portfolio",
        description: "The platform you are currently viewing. Built with Astro, React, and Tailwind CSS for maximum performance.",
        tags: ["Astro", "React", "Tailwind"],
        link: "",
        featured: false,
        modal: false,
        media: [] as MediaItem[],
        features: [],
        techStack: [],
        architecture: ""
    }
];

---

<StudioLayout title="Hardi Fusion Lab | Engineering Atelier" description="Engineering high-complexity systems across Quantitative Trading, Real-time Media, and Web3.">
  <div class="bg-black min-h-screen text-white relative selection:bg-blue-500/30 selection:text-white overflow-x-hidden">
    <!-- Global Atmosphere -->
    <div class="fixed inset-0 pointer-events-none -z-10">
        <div class="absolute inset-0 bg-grid-mesh [mask-image:radial-gradient(ellipse_60%_50%_at_50%_0%,#000_70%,transparent_100%)] opacity-20"></div>
        <div class="absolute top-[-10%] left-[20%] w-[500px] h-[500px] bg-blue-600/5 blur-[120px] rounded-full"></div>
        <div class="absolute bottom-[20%] right-[10%] w-[600px] h-[600px] bg-purple-600/5 blur-[140px] rounded-full"></div>
    </div>

    <Navigation />
    
    <main class="relative z-10 transition-all duration-700">
      <HeroSection />
      
      <AboutSection />

      {/* Skills Section */}
      <section id="skills" class="py-32 px-6 relative overflow-hidden">
        <div class="max-w-7xl mx-auto relative z-10">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-20 items-center">
            <div class="opacity-0 translate-y-10 transition-all duration-1000 ease-[cubic-bezier(0.16,1,0.3,1)]" data-animate-in>
              <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[10px] font-black uppercase tracking-[0.2em] mb-6">
                Expertise
              </div>
              <h2 class="text-fluid-h2 font-black mb-8 leading-none">Technical <br /><span class="text-white/40">Capabilities.</span></h2>
              <p class="text-gray-400 text-lg leading-relaxed mb-12 max-w-xl">
                Bridging the gap between low-latency performance systems and modern, intuitive user interfaces with a focus on scalability and security.
              </p>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                 {/* Simplified Category View */}
                 <div class="space-y-4">
                    <h4 class="text-xs font-bold text-white uppercase tracking-widest">Frontend</h4>
                    <div class="flex flex-wrap gap-2">
                        {skills.frontend.slice(0, 4).map(skill => <SkillBadge name={skill} />)}
                    </div>
                 </div>
                 <div class="space-y-4">
                    <h4 class="text-xs font-bold text-white uppercase tracking-widest">Backend</h4>
                    <div class="flex flex-wrap gap-2">
                        {skills.backend.slice(0, 4).map(skill => <SkillBadge name={skill} />)}
                    </div>
                 </div>
                 <div class="space-y-4">
                    <h4 class="text-xs font-bold text-white uppercase tracking-widest">Cloud</h4>
                    <div class="flex flex-wrap gap-2">
                        {skills.cloud.slice(0, 4).map(skill => <SkillBadge name={skill} />)}
                    </div>
                 </div>
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 opacity-0 translate-y-20 transition-all duration-1000 ease-[cubic-bezier(0.16,1,0.3,1)] delay-200" data-animate-in>
              <div class="space-y-4">
                <div class="h-32 rounded-3xl bg-blue-500/10 border border-blue-500/20 backdrop-blur-sm p-6 flex flex-col justify-end group hover:bg-blue-500/15 transition-all">
                    <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-1">Scale</span>
                    <span class="text-2xl font-black text-white">Distributed</span>
                </div>
                <div class="h-48 rounded-3xl bg-white/5 border border-white/10 backdrop-blur-sm p-6 flex flex-col justify-end group hover:bg-white/10 transition-all">
                    <div class="flex items-center gap-1 text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                        Matching
                    </div>
                    <span class="text-2xl font-black text-white">&lt;500Î¼s</span>
                </div>
              </div>
              <div class="space-y-4 pt-8">
                <div class="h-48 rounded-3xl bg-white/5 border border-white/10 backdrop-blur-sm p-6 flex flex-col justify-end group hover:bg-white/10 transition-all">
                    <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">Security</span>
                    <span class="text-2xl font-black text-white">Hardened</span>
                </div>
                <div class="h-32 rounded-3xl bg-purple-500/10 border border-purple-500/20 backdrop-blur-sm p-6 flex flex-col justify-end group hover:bg-purple-500/15 transition-all">
                    <span class="text-[10px] font-bold text-purple-400 uppercase tracking-widest mb-1">Logic</span>
                    <span class="text-2xl font-black text-white">Advanced</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* Projects Section */}
      <section id="projects" class="py-32 px-6">
        <div class="max-w-7xl mx-auto">
          <div class="flex items-end justify-between mb-16 px-2 opacity-0 translate-y-10 transition-all duration-1000 ease-[cubic-bezier(0.16,1,0.3,1)]" data-animate-in>
            <div>
              <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[10px] font-black uppercase tracking-[0.2em] mb-6">
                Works
              </div>
              <h2 class="text-fluid-h2 font-black leading-none">Selected <br /><span class="text-white/40">Projects.</span></h2>
            </div>
            <p class="hidden md:block text-gray-500 text-right max-w-[200px] text-sm font-medium italic">
                A curated selection of high-performance architecture.
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {projects.map((project, index) => (
              <div class="opacity-0 translate-y-10 transition-all duration-1000 ease-[cubic-bezier(0.16,1,0.3,1)]" style={`transition-delay: ${index * 100}ms`} data-animate-in>
                <ProjectCard
                  title={project.title}
                  description={project.shortDescription || project.description}
                  tags={project.tags}
                  featured={project.featured}
                  github={project.github}
                  link={project.link}
                  modalId={project.modal ? project.id : undefined}
                />
              </div>
            ))}
          </div>
        </div>
      </section>

      <InsightsSection insights={insights} />
    </main>

    <Footer />
    
    <script>
        document.addEventListener('astro:page-load', () => {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.remove('opacity-0', 'translate-y-10', 'translate-y-20');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('[data-animate-in]').forEach((el) => {
                observer.observe(el);
            });
        });
    </script>

    {/* Project Modals */}
    {projects.map(project => (
        project.modal && (
            <ProjectModal 
                id={project.id}
                title={project.title}
                description={project.description}
                shortDescription={project.shortDescription}
                media={project.media}
                tags={project.tags}
                features={project.features}
                techStack={project.techStack}
                architecture={project.architecture}
                github={project.github}
            />
        )
    ))}
  </div>
</StudioLayout>
